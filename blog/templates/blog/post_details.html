{% extends '_base.html' %}
{% load static %}
{% load mptt_tags %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-9">
            <div class="card my-3 custom-card border-0">
                <div class="card-body">
                    <div class="row">
                        <div class="card-text d-flex align-items-center justify-content-between mb-2">
                            <h4 class="d-flex align-items-center p-0">
                                <a href="{% url 'accounts:profile' slug=post.author.username %}">
                                    {{ post.author.first_name }} {{ post.author.last_name }}
                                </a> |
                                {{ post.created|date:'M d, Y' }}
                            </h4>

                            <div class="d-flex align-items-center justify-content-end">
                                {% if user.is_authenticated %}
                                    <span class="me-1 num-of-likes" id="num">{{ post.likes.count }}</span>
                                    <button class="btn btn-link text-dark p-0 border-0 btn-outline-light">
                                        {% if liked %}
                                            <i class="fa-solid fa-heart" id="like-button"></i>
                                        {% else %}
                                            <i class="fa-regular fa-heart" id="like-button"></i>
                                        {% endif %}
                                    </button>
                                {% else %}
                                    <span class="me-1 num-of-likes" id="num">{{ post.total_likes }}</span>
                                    <a href="{% url 'accounts:login' %}"
                                       class="btn btn-link text-dark p-0 border-0 btn-outline-light">
                                        <i class="fa-regular fa-heart"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row">
                            <span class="card-text d-flex m-0">
                                    <a class="fs-6 category mt-0 mb-2"
                                       href="{% url 'blog:category' post.category.slug %}">
                                        {{ post.category }}
                                    </a>
                            </span>
                            <span>
                                <small class="text-muted m-0">
                                    {% for tag in post.tags.all %}
                                        <a href="{% url 'blog:posts-by-tags' tag.slug %}"
                                           class="badge badge-light text-muted fw-light mb-2 tag">{{ tag.name }}</a>
                                    {% endfor %}
                                </small>
                            </span>
                        </div>
                        <hr>
                        <div class="row mt-4">
                            <div class="card-title">
                                <h1 class="display-5 text-center">{{ post.title }}</h1>
                            </div>
                            <img src="{{ post.images.url }}" alt="pic" class="img-thumbnail border-0 custom-card">
                            <p class="card-text">
                                {{ post.body|safe }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            {% if user.is_authenticated %}
                <div class="card border-0">
                    <div class="card-body custom-card">
                        <div class="card-title mb-3">Комментарии</div>
                        {% include 'blog/comments_list.html' %}
                    </div>
                </div>
            {% endif %}
        </div>
        <div class="col-md-3">
            <div class="card my-3 border-0 custom-card">
                <div class="card-body">
                    <div class="card-title">
                        <h4 class="text-center">Схожие посты</h4>
                    </div>
                </div>
                {% for post in similar_posts %}
                    <div class="card-body">
                        <img src="{{ post.images.url }}" alt="pic" class="card-img-top mb-1">
                        <h4 class="card-title fw-bold mb-2 fs-20">
                            <a href="{{ post.get_absolute_url }}">
                                {{ post.title }}
                            </a>
                        </h4>
                        <p class="card-text d-flex">
                            <small class="text-muted">
                                <span class="d-flex align-items-center mb-1">{{ post.created|date:'M d, Y' }}</span>
                                {% for tag in post.tags.all %}
                                    <a href="{% url 'blog:posts-by-tags' tag.slug %}"
                                       class="badge badge-light text-muted fw-light mb-1 tag">{{ tag.name }}</a>
                                {% endfor %}
                            </small>
                        </p>
                        <p class="card-text fs-15 text">
                            {{ post.snippet }}
                        </p>
                        <a href="{{ post.get_absolute_url }}" class="btn btn-outline custom-btn">Читать далее</a>
                    </div>
                {% empty %}
                    <h4>Постов с такими тегами еще нет</h4>
                {% endfor %}
            </div>
        </div>
    </div>
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        let btn = document.getElementById("like-button")
        let num_of_likes = document.getElementById("num")

        btn.addEventListener("click", likePost)

        function likePost(e) {
            e.preventDefault()
            let post_id = "{{post.id}}"
            let url = "{% url 'blog:like' %}"
            const data = {id: post_id}

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    "X-Requested-With": "XMLHttpRequest",
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(data),
                credentials: "same-origin"
            })
                .then(res => {
                    console.log(res.status);
                    return res.json();
                })
                .then(data => {
                    console.log(data)

                    if (data["check"] === 1) {
                        btn.classList.remove("fa-regular")
                        btn.classList.add('fa-solid')
                    } else if (data["check"] === 0) {
                        btn.classList.add("fa-regular")
                        btn.classList.remove('fa-solid')
                    }

                    num_of_likes.innerHTML = data["num_of_likes"]
                    console.log(num_of_likes);
                })
                .catch(error => {
                    console.log(error);
                })
        }
    </script>
{% endblock %}